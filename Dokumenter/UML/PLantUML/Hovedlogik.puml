@startuml MainActivityCompactLoop
start

if (WiFi connected?) then (no)
  :print("Fejl: WiFi ikke forbundet.");
  stop
else (yes)
  :Init gps, tb, bremselys(i2c), battery(i2c);
  :tb.connect();

  :Initial GPS read (10s);
  if (GPS valid?) then (yes)
    :Send GPS to TB;
    :battery.set_gps(...);
    :had_fix = true;
  else (no)
    :had_fix = false;
  endif

  :Get twilight (10s);
  if (Twilight + begin/end valid?) then (yes)
    :bremselys.set_twilight(begin,end);
  else (no)
    :Skip set_twilight;
  endif

  :Init timers + theft flags;

  while (Main loop) is (repeat)

    :bremselys.step();
    :now = time.time();

    if (theft_alert AND time to send?) then (yes)
      :Read GPS (3s);
      if (GPS valid?) then (yes)
        :Send GPS to TB;
        :had_fix = true;
      else (no)
        :Skip send;
      endif
      :last_theft_gps_send = now;
    else (no)
      :Skip theft send;
    endif

    if (Time for GPS check?) then (yes)
      :Read GPS (3s);

      if (GPS valid?) then (yes)
        :battery.set_gps(...);
        :had_fix = true;

        if (First fix?) then (yes)
          :Store last_lat/lng;\nlast_move_time = now;
        else (no)
          :distance = haversine(last -> current);
          if (Moved >= threshold?) then (yes)
            :last_move_time = now;
            if (theft_armed AND NOT theft_alert?) then (trigger)
              :theft_alert = true;\ntheft_armed = false;
              :TB telemetry theft_alert=1;
            else (no)
              :No theft trigger;
            endif
          else (no)
            if (Stationary >= STATIONARY_SECONDS\nAND had_fix AND NOT theft_alert?) then (arm)
              :theft_armed = true;
            else (no)
              :Keep state;
            endif
          endif
          :Update last_lat/lng;
        endif

      else (no)
        :No valid GPS fix;
      endif

      :last_gps_check = now;
    else (no)
      :Skip GPS check;
    endif

    if (Time for battery LCD update?) then (yes)
      :battery.step();
      :last_battery_update = now;
    else (no)
      :Skip battery step;
    endif

    if (Time for TB periodic update?) then (yes)
      :Read GPS (3s);
      if (GPS valid?) then (yes)
        :Send GPS to TB;\nbattery.set_gps(...);
        :Get twilight (10s);
        if (Twilight + begin/end valid?) then (yes)
          :bremselys.set_twilight(begin,end);
        else (no)
          :Skip set_twilight;
        endif
      else (no)
        :Skip GPS send;
      endif

      :Send battery_pct + temperature to TB;
      :last_tb_update = now;
    else (no)
      :Skip TB update;
    endif

    :sleep(0.1);

  endwhile (loop)
endif

@enduml